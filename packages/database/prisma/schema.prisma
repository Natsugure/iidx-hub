// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Version {
  id            String      @id  // 1, SS, 2, 3...30, 31...
  name          String   // "1st style", "RESIDENT"
  
  songs         Song[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("versions")
}


model Song {
  id            String   @id @default(uuid())
  
  // textage.cc の識別子
  textageSlug        String   @unique  // textageの内部一意識別子 (例: 'a_amuro')
  textageNumIndex    Int?     // titletbl.js の内部インデックス
  
  title         String
  titleKana     String?
  genre         String
  artist        String
  
  versionId     String?     // AC版のバージョン（INF限定ならnull）
  version       Version? @relation(fields: [versionId], references: [id])
  
  isInAC        Boolean  @default(true)
  isInINFINITAS Boolean  @default(false)
  
  charts        Chart[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([title])
  @@index([versionId])
  @@index([textageSlug])

  @@map("songs")
}

model Chart {
  id                String   @id @default(uuid())
  songId            String
  song              Song     @relation(fields: [songId], references: [id], onDelete: Cascade)
  
  playStyle         PlayStyle
  difficulty        Difficulty
  level             Int      // 公式レベル (1-12)
  bpm               String?
  notes             Int?
  isInAC            Boolean  @default(true)
  isInINFINITAS     Boolean  @default(false)       

  unofficialClearLevel   String?  // ノマゲ難易度
  unofficialHardLevel    String?  // ハード難易度
  
  easyCpi                Decimal?  @db.Decimal(6, 2)
  clearCpi               Decimal?  @db.Decimal(6, 2)
  hardCpi                Decimal?  @db.Decimal(6, 2)
  exhCpi                 Decimal?  @db.Decimal(6, 2)
  fcCpi                  Decimal?  @db.Decimal(6, 2)

  easyIndividualVariation    Decimal?  @db.Decimal(6, 2)
  clearIndividualVariation   Decimal?  @db.Decimal(6, 2)
  hardIndividualVariation    Decimal?  @db.Decimal(6, 2)
  exhIndividualVariation     Decimal?  @db.Decimal(6, 2)
  fcIndividualVariation      Decimal?  @db.Decimal(6, 2)

  wikiUrl           String?    // atwiki攻略ページURL
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([songId, playStyle, difficulty])
  @@index([playStyle, level])
  @@index([unofficialClearLevel])
  @@index([unofficialHardLevel])

  @@map("charts")
}

enum PlayStyle {
  SP
  DP
}

enum Difficulty {
  BEGINNER
  NORMAL
  HYPER
  ANOTHER
  LEGGENDARIA
}

model ScraperRun {
  id          String   @id @default(uuid())
  startedAt   DateTime @default(now())
  completedAt DateTime?
  success     Boolean  @default(false)
  
  source      String   // "textage_actbl", "textage_titletbl", "sp12_table" など
  songsFound  Int?
  songsAdded  Int?
  songsUpdated Int?
  errorMessage String?
  
  @@index([startedAt])
  @@index([source])

  @@map("scraperRuns")
}